<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using Go Maps: pointers and value types | GlacierZero</title><meta name=keywords content="go,data structures"><meta name=description content="Hash maps are often a good data structure when we want to access or store pairs of associated data; pairs commonly known as key-value.
What makes a hash table (a map) a great data structure is that internally it will compute an index based on the key, that will point us to where our value is. This is what makes them so fast to insert O(1), delete O(1) and search O(1) for most cases (on average) with unordered data, while taking O(n) space."><meta name=author content="Plácido Fernández Declara"><link rel=canonical href=https://glacierzero.com/blog/go_maps_usage/><link href=/assets/css/stylesheet.min.7ecdd2a0bea01220d537dc996887b7b956c0bfd8880d1b1fb4bd7d93674ee44e.css integrity="sha256-fs3SoL6gEiDVN9yZaIe3uVbAv9iIDRsftL19k2dO5E4=" rel="preload stylesheet" as=style><link rel=icon href=https://glacierzero.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://glacierzero.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://glacierzero.com/favicon-32x32.png><link rel=apple-touch-icon href=https://glacierzero.com/apple-touch-icon.png><link rel=mask-icon href=https://glacierzero.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.96.0"><meta property="og:title" content="Using Go Maps: pointers and value types"><meta property="og:description" content="Hash maps are often a good data structure when we want to access or store pairs of associated data; pairs commonly known as key-value.
What makes a hash table (a map) a great data structure is that internally it will compute an index based on the key, that will point us to where our value is. This is what makes them so fast to insert O(1), delete O(1) and search O(1) for most cases (on average) with unordered data, while taking O(n) space."><meta property="og:type" content="article"><meta property="og:url" content="https://glacierzero.com/blog/go_maps_usage/"><meta property="og:image" content="https://glacierzero.com/blog/img/go_hash_maps.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-02-14T00:11:38+01:00"><meta property="article:modified_time" content="2022-02-14T00:11:38+01:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://glacierzero.com/blog/img/go_hash_maps.png"><meta name=twitter:title content="Using Go Maps: pointers and value types"><meta name=twitter:description content="Hash maps are often a good data structure when we want to access or store pairs of associated data; pairs commonly known as key-value.
What makes a hash table (a map) a great data structure is that internally it will compute an index based on the key, that will point us to where our value is. This is what makes them so fast to insert O(1), delete O(1) and search O(1) for most cases (on average) with unordered data, while taking O(n) space."><meta name=twitter:site content="@glacierzero"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Blogs","item":"https://glacierzero.com/blog/"},{"@type":"ListItem","position":3,"name":"Using Go Maps: pointers and value types","item":"https://glacierzero.com/blog/go_maps_usage/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using Go Maps: pointers and value types","name":"Using Go Maps: pointers and value types","description":"Hash maps are often a good data structure when we want to access or store pairs of associated data; pairs commonly known as key-value.\nWhat makes a hash table (a map) a great data structure is that internally it will compute an index based on the key, that will point us to where our value is. This is what makes them so fast to insert O(1), delete O(1) and search O(1) for most cases (on average) with unordered data, while taking O(n) space.","keywords":["go","data structures"],"articleBody":"Hash maps are often a good data structure when we want to access or store pairs of associated data; pairs commonly known as key-value.\nWhat makes a hash table (a map) a great data structure is that internally it will compute an index based on the key, that will point us to where our value is. This is what makes them so fast to insert O(1), delete O(1) and search O(1) for most cases (on average) with unordered data, while taking O(n) space. This makes them much faster (on average) than arrays to search, insert and delete elements on it.\nGiven a key, we directly know where in memory our value will be. Not everything is great about hash tables though. Elements will be sparsely distributed in memory, which makes it cache un-friendly, you can have collisions when generating the indices, and the worst-case scenarios are usually O(n) and must be taken into consideration.\nGo lang inadvertently exposes some of this behaviour when trying to perform certain operations on them, like assigning a struct field in a map. Using go maps one may try to do something like this:\npackage main  type MyStruct struct {  ID int  Amount float64 }  func main() {  operations := make(map[string]MyStruct)  operations[\"Name1\"] = MyStruct{256, 1.234}  operations[\"Name1\"].Amount = 5.678 } for what we would get the following error:\n./got1.go:11:32: cannot assign to struct field operations[\"Name1\"].Amount in map We can add new key-values to the map with no issue:\noperations[\"Name2\"] = MyStruct{128, 9.876} But we cannot modify an existing struct value. This is because in Go, map values are not addressable. In Go maps values can change their location in memory, for example when a hash map grows it may reallocate to use extra space; in that case the old memory locations will become invalid, so assigning this way is not allowed.\nThere are various solutions or ways around this issue. We can read the value into a new variable and then assign the new variable to that key:\noperations := make(map[string]MyStruct) operations[\"Name1\"] = MyStruct{256, 1.234} mod_op := operations[\"Name1\"] mod_op.Amount = 5.678 operations[\"Name1\"] = mod_op A similar approach is to check if there is a value: Go returns a copy of the value and a bool to know if there was a value or not. Since we get a copy of the value, we can modify it and re-assign it:\noperations := make(map[string]MyStruct) operations[\"Name1\"] = MyStruct{256, 1.234} if op, ok := operations[\"Name1\"]; ok {  op.Amount = 5.678  operations[\"Name1\"] = op } else {  // not ok: There was no value for \"Name1\" } A third approach is to directly use pointers: a map of keys to pointers to values. This approach can have a performance benefit, specially for big structs if these are being copied:\noperations := make(map[string]*MyStruct) operations[\"Name1\"] = \u0026MyStruct{256, 1.234} operations[\"Name1\"].Amount = 5.678 Go lang Map design is tricky when coming from other languages. Under the hood maps are pointers to to runtime.hmap, and not values as one might expect, causing the confusion.\n","wordCount":"498","inLanguage":"en","datePublished":"2022-02-14T00:11:38+01:00","dateModified":"2022-02-14T00:11:38+01:00","author":{"@type":"Person","name":"Plácido Fernández Declara"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://glacierzero.com/blog/go_maps_usage/"},"publisher":{"@type":"Organization","name":"GlacierZero","logo":{"@type":"ImageObject","url":"https://glacierzero.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://glacierzero.com accesskey=h title="GlacierZero (Alt + H)">GlacierZero</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://glacierzero.com/about/ title=About><span>About</span></a></li><li><a href=https://glacierzero.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://glacierzero.com/archive/ title=Archive><span>Archive</span></a></li><li><a href=https://glacierzero.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://glacierzero.com>Home</a>&nbsp;»&nbsp;<a href=https://glacierzero.com/blog/>Blogs</a></div><h1 class=post-title>Using Go Maps: pointers and value types</h1><div class=post-meta>14 February 2022&nbsp;·&nbsp;Plácido Fernández Declara</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner></div></details></div><div class=post-content><p>Hash maps are often a good data structure when we want to access or store pairs of associated data; pairs commonly known as key-value.</p><p>What makes a hash table (a map) a great data structure is that internally it will compute an index based on the key, that will point us to where our value is. This is what makes them so fast to insert <em>O(1)</em>, delete <em>O(1)</em> and search <em>O(1)</em> for most cases (on average) with unordered data, while taking <em>O(n)</em> space. This makes them much faster (on average) than arrays to search, insert and delete elements on it.</p><p>Given a key, we directly know where in memory our value will be. Not everything is great about hash tables though. Elements will be sparsely distributed in memory, which makes it cache <strong>un</strong>-friendly, you can have <a href>collisions</a> when generating the indices, and the worst-case scenarios are usually <em>O(n)</em> and must be taken into consideration.</p><p>Go lang inadvertently exposes some of this behaviour when trying to perform certain operations on them, like assigning a struct field in a map. Using go maps one may try to do something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MyStruct</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ID</span>      <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Amount</span>  <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>operations</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>MyStruct</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>operations</span>[<span style=color:#e6db74>&#34;Name1&#34;</span>] = <span style=color:#a6e22e>MyStruct</span>{<span style=color:#ae81ff>256</span>, <span style=color:#ae81ff>1.234</span>}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>operations</span>[<span style=color:#e6db74>&#34;Name1&#34;</span>].<span style=color:#a6e22e>Amount</span> = <span style=color:#ae81ff>5.678</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>for what we would get the following error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>./got1.go:11:32: cannot assign to struct field operations<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;Name1&#34;</span><span style=color:#f92672>]</span>.Amount in map
</span></span></code></pre></div><p>We can add new key-values to the map with no issue:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>operations</span>[<span style=color:#e6db74>&#34;Name2&#34;</span>] = <span style=color:#a6e22e>MyStruct</span>{<span style=color:#ae81ff>128</span>, <span style=color:#ae81ff>9.876</span>}
</span></span></code></pre></div><p>But we cannot modify an existing struct value. This is because in Go, map values are not <a href=https://go.dev/ref/spec#Address_operators>addressable</a>. In Go maps values can change their location in memory, for example when a hash map grows it may reallocate to use extra space; in that case the old memory locations will become invalid, so assigning this way is not allowed.</p><p>There are various solutions or ways around this issue.
We can read the value into a new variable and then assign the new variable to that key:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>operations</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>MyStruct</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>operations</span>[<span style=color:#e6db74>&#34;Name1&#34;</span>] = <span style=color:#a6e22e>MyStruct</span>{<span style=color:#ae81ff>256</span>, <span style=color:#ae81ff>1.234</span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>mod_op</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>operations</span>[<span style=color:#e6db74>&#34;Name1&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>mod_op</span>.<span style=color:#a6e22e>Amount</span> = <span style=color:#ae81ff>5.678</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>operations</span>[<span style=color:#e6db74>&#34;Name1&#34;</span>] = <span style=color:#a6e22e>mod_op</span>
</span></span></code></pre></div><p>A similar approach is to check if there is a value: Go returns a copy of the value and a bool to know if there was a value or not. Since we get a copy of the value, we can modify it and re-assign it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>operations</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>MyStruct</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>operations</span>[<span style=color:#e6db74>&#34;Name1&#34;</span>] = <span style=color:#a6e22e>MyStruct</span>{<span style=color:#ae81ff>256</span>, <span style=color:#ae81ff>1.234</span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>op</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>operations</span>[<span style=color:#e6db74>&#34;Name1&#34;</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Amount</span> = <span style=color:#ae81ff>5.678</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>operations</span>[<span style=color:#e6db74>&#34;Name1&#34;</span>] = <span style=color:#a6e22e>op</span>
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// not ok: There was no value for &#34;Name1&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>A third approach is to directly use pointers: a map of keys to pointers to values. This approach can have a performance benefit, specially for big structs if these are being copied:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>operations</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>MyStruct</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>operations</span>[<span style=color:#e6db74>&#34;Name1&#34;</span>] = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>MyStruct</span>{<span style=color:#ae81ff>256</span>, <span style=color:#ae81ff>1.234</span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>operations</span>[<span style=color:#e6db74>&#34;Name1&#34;</span>].<span style=color:#a6e22e>Amount</span> = <span style=color:#ae81ff>5.678</span>
</span></span></code></pre></div><p>Go lang Map design is tricky when coming from other languages. Under the hood maps are pointers to to <a href=https://go.dev/src/runtime/map.go><code>runtime.hmap</code></a>, and not values as one might expect, causing the confusion.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://glacierzero.com/tags/go/>go</a></li><li><a href=https://glacierzero.com/tags/data-structures/>data structures</a></li></ul><nav class=paginav><a class=prev href=https://glacierzero.com/blog/using_spack/><span class=title>« Prev Page</span><br><span>Using Spack package manager for supercomputers to install software locally</span></a>
<a class=next href=https://glacierzero.com/blog/symbol_names_english/><span class=title>Next Page »</span><br><span>Names of symbols when programming, in english</span></a></nav></footer><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://glacierzero.com/blog/go_maps_usage/",this.page.identifier="https://glacierzero.com/blog/go_maps_usage/"};(function(){var e=document,t=e.createElement("script");t.src="https://glacierzero.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></article></main><footer class=footer><span>&copy; 2022 <a href=https://glacierzero.com>GlacierZero</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById("menu").scrollLeft=localStorage.getItem("menu-scroll-position"))};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById("menu").scrollLeft)}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>